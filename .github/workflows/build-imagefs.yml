name: build-imagefs

on:
  workflow_dispatch:
    inputs:
      rootfs_tzst_url:
        description: 'URL to rootfs.tzst'
        required: false
        default: 'https://github.com/Waim908/rootfs-custom-winlator/releases/download/ori-b11.0/rootfs.tzst'
      base_imagefs_tar_url:
        description: 'Optional imagefs bundle (.tar.xz) to overlay /opt/wine'
        required: false
        default: 'https://github.com/FrontMage/winlator-llm/releases/download/imagefs-v1/imagefs-v1.tar.xz'
      enable_auth_deps:
        description: 'Install NTLM/Kerberos deps into imagefs (1/0)'
        required: false
        default: '1'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zstd xz-utils rsync
      - name: Build imagefs
        env:
          ROOTFS_TZST_URL: ${{ inputs.rootfs_tzst_url }}
          BASE_IMAGEFS_TAR_URL: ${{ inputs.base_imagefs_tar_url }}
          ENABLE_AUTH_DEPS: ${{ inputs.enable_auth_deps }}
          OUT_DIR: ${{ github.workspace }}/dist
        run: |
          scripts/build-imagefs.sh
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: imagefs
          path: dist/imagefs.txz
